#include <stdio.h>
#include <assert.h>

// File generated by --header switch inside the nimcache directory.
#include "test_c_api.h"

const char* valid_rst_string = "Embedded *rst* text";
const char* bad_rst_string = "Asterisks and Obelix\n"
	"====================\n"
	"\n"
	"These asterisks* are bad for rst.\n"
	"\n"
	"* Not that we really care.\n"
	"\n"
	// The underscore will be replaced at runtime!
	"Or was <B it _single quotes?";

// Entry point of the C test.
void run_c_test(void)
{
	printf("Using lazy_rest %s.\n", lr_version_str());

	int major = 6, minor = 6, maintenance = 6;
	lr_version_int(&major, &minor, &maintenance);
	printf("Using lazy_rest: %d-%d-%d.\n",
		major, minor, maintenance);

	{
		char *s = lr_rst_string_to_html(valid_rst_string,
			"<string>", 0);
		assert(0 != s);
		if (s) {
			// Success!
			assert(strstr(s, "<title>"));
		} else {
			// Handle error.
		}
	}

	{
		// Due to backticks being escaped in Nimrod's emit pragma (see
		// https://github.com/Araq/Nimrod/issues/1588) we have to modify the
		// bad_rst_string constant at runtime to avoid it being escaped during
		// Nimrod's C codegen phase.
		char buf[200];
		assert(sizeof(buf) >= strlen(bad_rst_string));
		assert(strchr(bad_rst_string, '_'));
		strcpy(buf, bad_rst_string);
		*strchr(buf, '_') = 0x60;

		char *s = lr_rst_string_to_html(buf,
			"<bad-string>", 0);
		assert(0 == s);
		if (!s) {
			// Handle error.
			printf("Error processing string: %s\n",
				lr_rst_string_to_html_error());
		}
	}

}
